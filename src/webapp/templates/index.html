<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoCrop Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>üì∏ PhotoCrop Dashboard</h1>
            <p class="subtitle">Sistema de Procesamiento de Fotos con IA</p>
        </header>

        <!-- Control Panel -->
        <section class="control-panel">
            <div class="card">
                <h2>Control de Procesamiento</h2>
                <div class="buttons-grid">
                    <button id="btnProcess" class="btn btn-primary" onclick="startProcessing()">
                        üöÄ Procesar Fotos (Completo)
                    </button>
                    <button id="btnRemoveBg" class="btn btn-secondary" onclick="removeBackground()">
                        üé® Quitar Fondo
                    </button>
                    <button id="btnConvertFormat" class="btn btn-secondary" onclick="convertFormat()">
                        üîÑ Convertir Formato
                    </button>
                </div>
                <div id="processingStatus" class="status-message"></div>
            </div>
        </section>

        <!-- Statistics Dashboard -->
        <section class="stats-grid">
            <!-- Input Raw -->
            <div class="stat-card">
                <div class="stat-icon">üì•</div>
                <div class="stat-value" id="statInputRaw">-</div>
                <div class="stat-label">Fotos en Input</div>
            </div>

            <!-- Processed -->
            <div class="stat-card success">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-value" id="statProcessed">-</div>
                <div class="stat-label">Procesadas</div>
            </div>

            <!-- Manual Review -->
            <div class="stat-card warning">
                <div class="stat-icon">‚ö†Ô∏è</div>
                <div class="stat-value" id="statManualReview">-</div>
                <div class="stat-label">Revisi√≥n Manual</div>
            </div>

            <!-- Errors -->
            <div class="stat-card error">
                <div class="stat-icon">‚ùå</div>
                <div class="stat-value" id="statErrors">-</div>
                <div class="stat-label">Errores</div>
            </div>

            <!-- Output White -->
            <div class="stat-card">
                <div class="stat-icon">üé®</div>
                <div class="stat-value" id="statOutputWhite">-</div>
                <div class="stat-label">Fondo Blanco</div>
            </div>

            <!-- Output Final -->
            <div class="stat-card success">
                <div class="stat-icon">üéØ</div>
                <div class="stat-value" id="statOutputFinal">-</div>
                <div class="stat-label">Finales</div>
            </div>
        </section>

        <!-- Folders Section -->
        <section class="folders-section">
            <h2>üìÇ Carpetas del Sistema</h2>

            <div class="tabs">
                <button class="tab-btn active" onclick="showFolder('output')">Output</button>
                <button class="tab-btn" onclick="showFolder('output_white')">Fondo Blanco</button>
                <button class="tab-btn" onclick="showFolder('output_final')">Final</button>
                <button class="tab-btn" onclick="showFolder('manual_review')">Revisi√≥n Manual</button>
                <button class="tab-btn" onclick="showFolder('errors')">Errores</button>
            </div>

            <div id="folderContent" class="folder-content">
                <p class="loading">Cargando...</p>
            </div>
        </section>

        <!-- Logs Section -->
        <section class="logs-section">
            <div class="card">
                <h2>üìã Logs del Sistema</h2>
                <button class="btn btn-secondary" onclick="refreshLogs()">üîÑ Actualizar Logs</button>
                <div id="logsContainer" class="logs-container">
                    <p class="loading">Cargando logs...</p>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer>
            <p>PhotoCrop Dashboard v1.0 | √öltima actualizaci√≥n: <span id="lastUpdate">-</span></p>
        </footer>
    </div>

    <!-- JavaScript -->
    <script>
        let autoRefresh = true;
        let currentFolder = 'output';

        // Funci√≥n para actualizar estad√≠sticas
        async function updateStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                // Actualizar contadores de carpetas
                document.getElementById('statInputRaw').textContent = data.folders.input_raw;
                document.getElementById('statProcessed').textContent = data.processed.successful;
                document.getElementById('statManualReview').textContent = data.processed.manual_review;
                document.getElementById('statErrors').textContent = data.processed.errors;
                document.getElementById('statOutputWhite').textContent = data.folders.output_white;
                document.getElementById('statOutputFinal').textContent = data.folders.output_final;

                // Actualizar estado de procesamiento
                const statusDiv = document.getElementById('processingStatus');
                const btnProcess = document.getElementById('btnProcess');
                const btnRemoveBg = document.getElementById('btnRemoveBg');
                const btnConvertFormat = document.getElementById('btnConvertFormat');

                if (data.processing.is_processing) {
                    statusDiv.innerHTML = '<div class="alert alert-info">‚è≥ Procesando fotos...</div>';
                    btnProcess.disabled = true;
                    btnRemoveBg.disabled = true;
                    btnConvertFormat.disabled = true;
                } else {
                    btnProcess.disabled = false;
                    btnRemoveBg.disabled = false;
                    btnConvertFormat.disabled = false;
                    if (data.processing.error) {
                        statusDiv.innerHTML = `<div class="alert alert-error">‚ùå Error: ${data.processing.error}</div>`;
                    } else if (data.processing.last_run) {
                        statusDiv.innerHTML = `<div class="alert alert-success">‚úÖ √öltima ejecuci√≥n: ${new Date(data.processing.last_run).toLocaleString()}</div>`;
                    } else {
                        statusDiv.innerHTML = '';
                    }
                }

                // Actualizar timestamp
                document.getElementById('lastUpdate').textContent = new Date(data.timestamp).toLocaleTimeString();

            } catch (error) {
                console.error('Error al actualizar stats:', error);
            }
        }

        // Funci√≥n para iniciar procesamiento completo
        async function startProcessing() {
            const result = await Swal.fire({
                title: 'üöÄ Procesamiento Completo',
                html: '¬øIniciar el procesamiento completo de nuevas fotos?<br><br>' +
                      '<small>‚Ä¢ Detecci√≥n facial<br>‚Ä¢ Recorte inteligente<br>‚Ä¢ Quitar fondo<br>‚Ä¢ Convertir formato</small>',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'S√≠, procesar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#667eea',
                cancelButtonColor: '#d33'
            });

            if (!result.isConfirmed) return;

            // Mostrar barra de progreso
            Swal.fire({
                title: '‚è≥ Procesando fotos...',
                html: '<b></b> fotos procesadas.<br><br>' +
                      '<div class="progress-bar-container">' +
                      '<div class="progress-bar" id="progressBar"></div>' +
                      '</div>' +
                      '<div id="progressText">Iniciando...</div>',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Iniciar monitoreo de progreso
            let progressInterval = setInterval(updateProgress, 1000);

            try {
                const response = await fetch('/api/process', {
                    method: 'POST'
                });
                const data = await response.json();

                clearInterval(progressInterval);

                if (data.success) {
                    await Swal.fire({
                        icon: 'success',
                        title: '‚úÖ ¬°Procesamiento Iniciado!',
                        html: 'El procesamiento est√° en curso.<br>Los resultados se actualizar√°n autom√°ticamente.',
                        confirmButtonColor: '#667eea',
                        timer: 3000
                    });
                    updateStats();
                } else {
                    await Swal.fire({
                        icon: 'error',
                        title: '‚ùå Error',
                        text: data.message,
                        confirmButtonColor: '#667eea'
                    });
                }
            } catch (error) {
                clearInterval(progressInterval);
                await Swal.fire({
                    icon: 'error',
                    title: '‚ùå Error',
                    text: 'Error al iniciar procesamiento: ' + error.message,
                    confirmButtonColor: '#667eea'
                });
            }
        }

        // Funci√≥n para actualizar progreso visual
        async function updateProgress() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                const total = data.folders.input_raw || 0;
                const processed = data.processed.total_processed || 0;

                if (total > 0) {
                    const percentage = Math.min((processed / total) * 100, 100);
                    const progressBar = document.getElementById('progressBar');
                    const progressText = document.getElementById('progressText');

                    if (progressBar) {
                        progressBar.style.width = percentage + '%';
                    }
                    if (progressText) {
                        progressText.innerHTML = `Procesadas: ${processed} de ${total} (${percentage.toFixed(0)}%)`;
                    }

                    const contentElement = Swal.getHtmlContainer().querySelector('b');
                    if (contentElement) {
                        contentElement.textContent = processed;
                    }
                }
            } catch (error) {
                console.error('Error actualizando progreso:', error);
            }
        }

        // Funci√≥n para quitar fondo
        async function removeBackground() {
            const result = await Swal.fire({
                title: 'üé® Quitar Fondo',
                html: '¬øQuitar fondo de las fotos en <b>output/</b>?<br><br>' +
                      '<small>Genera fotos con fondo blanco en <b>output_white/</b></small>',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'S√≠, quitar fondo',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#f093fb',
                cancelButtonColor: '#d33'
            });

            if (!result.isConfirmed) return;

            // Mostrar loading
            Swal.fire({
                title: 'üé® Quitando fondo...',
                html: 'Procesando im√°genes con IA',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const response = await fetch('/api/remove-background', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    await Swal.fire({
                        icon: 'success',
                        title: '‚úÖ Fondo Removido',
                        html: `<b>${data.processed || 0}</b> fotos procesadas correctamente`,
                        confirmButtonColor: '#f093fb'
                    });
                    updateStats();
                } else {
                    await Swal.fire({
                        icon: 'error',
                        title: '‚ùå Error',
                        text: data.message,
                        confirmButtonColor: '#f093fb'
                    });
                }
            } catch (error) {
                await Swal.fire({
                    icon: 'error',
                    title: '‚ùå Error',
                    text: 'Error al quitar fondo: ' + error.message,
                    confirmButtonColor: '#f093fb'
                });
            }
        }

        // Funci√≥n para convertir formato
        async function convertFormat() {
            const result = await Swal.fire({
                title: 'üîÑ Convertir Formato',
                html: '¬øConvertir fotos de <b>output_white/</b> a formato original?<br><br>' +
                      '<small>Genera fotos finales en <b>output_final/</b></small>',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'S√≠, convertir',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#f5576c',
                cancelButtonColor: '#d33'
            });

            if (!result.isConfirmed) return;

            // Mostrar loading
            Swal.fire({
                title: 'üîÑ Convirtiendo formato...',
                html: 'Procesando archivos',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const response = await fetch('/api/convert-format', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    await Swal.fire({
                        icon: 'success',
                        title: '‚úÖ Formato Convertido',
                        html: `<b>${data.converted || 0}</b> fotos convertidas al formato original`,
                        confirmButtonColor: '#f5576c'
                    });
                    updateStats();
                } else {
                    await Swal.fire({
                        icon: 'error',
                        title: '‚ùå Error',
                        text: data.message,
                        confirmButtonColor: '#f5576c'
                    });
                }
            } catch (error) {
                await Swal.fire({
                    icon: 'error',
                    title: '‚ùå Error',
                    text: 'Error al convertir formato: ' + error.message,
                    confirmButtonColor: '#f5576c'
                });
            }
        }

        // Funci√≥n para mostrar carpeta
        async function showFolder(folder) {
            currentFolder = folder;

            // Actualizar tabs activos
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Cargar contenido
            const contentDiv = document.getElementById('folderContent');
            contentDiv.innerHTML = '<p class="loading">Cargando...</p>';

            try {
                const response = await fetch(`/api/images/${folder}`);
                const data = await response.json();

                if (data.images.length === 0) {
                    contentDiv.innerHTML = '<p class="empty">No hay im√°genes en esta carpeta</p>';
                    return;
                }

                let html = '<div class="images-grid">';
                data.images.forEach(img => {
                    const sizeKB = (img.size / 1024).toFixed(1);
                    html += `
                        <div class="image-card">
                            <div class="image-name">${img.name}</div>
                            <div class="image-info">
                                <span>üì¶ ${sizeKB} KB</span>
                                <span>üïê ${img.modified}</span>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                contentDiv.innerHTML = html;

            } catch (error) {
                contentDiv.innerHTML = `<p class="error">Error al cargar im√°genes: ${error.message}</p>`;
            }
        }

        // Funci√≥n para actualizar logs
        async function refreshLogs() {
            const logsDiv = document.getElementById('logsContainer');
            logsDiv.innerHTML = '<p class="loading">Cargando logs...</p>';

            try {
                const response = await fetch('/api/logs?lines=50');
                const data = await response.json();

                if (data.logs.length === 0) {
                    logsDiv.innerHTML = '<p class="empty">No hay logs disponibles</p>';
                    return;
                }

                let html = '<pre class="logs-text">';
                data.logs.forEach(line => {
                    html += line;
                });
                html += '</pre>';

                logsDiv.innerHTML = html;

                // Auto-scroll al final
                logsDiv.scrollTop = logsDiv.scrollHeight;

            } catch (error) {
                logsDiv.innerHTML = `<p class="error">Error al cargar logs: ${error.message}</p>`;
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            refreshLogs();
            showFolder('output');

            // Auto-refresh cada 5 segundos
            setInterval(() => {
                if (autoRefresh) {
                    updateStats();
                }
            }, 5000);
        });
    </script>
</body>
</html>

